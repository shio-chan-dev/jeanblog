# ğŸ›°ï¸ WebSocket æ·±å…¥ç†è§£ï¼šä¸ºä»€ä¹ˆè¦ä¿æŒä¸€ä¸ªâ€œæ°¸è¿œåœ¨çº¿â€çš„è¿æ¥ï¼Ÿ

## âœ¨ å‰¯æ ‡é¢˜ / æ‘˜è¦

è¿™ç¯‡æ–‡ç« å¸¦ä½ å½»åº•ææ‡‚ WebSocketï¼š
å®ƒå’Œ HTTP çš„æ ¹æœ¬åŒºåˆ«ã€ä¸ºä»€ä¹ˆéœ€è¦â€œé•¿è¿æ¥â€ã€è¿æ¥æ˜¯å¦‚ä½•å»ºç«‹å’Œä¿æŒçš„ã€ä»¥åŠå®ƒåœ¨å®æ—¶åº”ç”¨ä¸­çš„æ„ä¹‰ã€‚
é€‚åˆæƒ³ä»â€œçŸ¥é“æ˜¯ä»€ä¹ˆâ€åˆ°â€œç†è§£ä¸ºä»€ä¹ˆâ€çš„å¼€å‘è€…ã€‚

---

## ğŸ‘©â€ğŸ’» ç›®æ ‡è¯»è€…

* Web å‰åç«¯åˆçº§åˆ°ä¸­çº§å¼€å‘è€…
* æƒ³å®ç°å®æ—¶èŠå¤©ã€AI æµå¼è¾“å‡ºã€åä½œç³»ç»Ÿçš„å·¥ç¨‹å¸ˆ
* æƒ³ä» HTTP æ¨¡å‹è¿‡æ¸¡åˆ°å®æ—¶æ¶æ„æ€ç»´çš„å­¦ä¹ è€…

---

## ğŸ§­ èƒŒæ™¯ / åŠ¨æœºï¼šä¸ºä»€ä¹ˆè¿™ä¸ªé—®é¢˜é‡è¦ï¼Ÿ

å‡ ä¹æ¯ä¸ªç°ä»£ Web åº”ç”¨éƒ½æ¶‰åŠâ€œå®æ—¶â€åŠŸèƒ½ï¼š

* èŠå¤©å¯¹è¯ï¼ˆChatGPTã€Slackï¼‰
* å®æ—¶é€šçŸ¥ï¼ˆé‚®ç®±ã€æ¶ˆæ¯æé†’ï¼‰
* åœ¨çº¿åä½œï¼ˆNotionã€Google Docsï¼‰
* æ•°æ®çœ‹æ¿ï¼ˆå®æ—¶æŒ‡æ ‡ã€ç›‘æ§ï¼‰

ç„¶è€Œï¼Œä¼ ç»Ÿçš„ HTTP æ˜¯â€œä¸€é—®ä¸€ç­”â€çš„åè®®ï¼Œ
æ— æ³•æ»¡è¶³**æœåŠ¡å™¨ä¸»åŠ¨é€šçŸ¥å®¢æˆ·ç«¯**ã€**ä½å»¶è¿ŸåŒå‘é€šä¿¡**çš„éœ€æ±‚ã€‚

> **WebSocket çš„å‡ºç°**ï¼Œå½»åº•æ”¹å˜äº†è¿™ç§å•å‘å…³ç³»ï¼Œ
> è®© Web åº”ç”¨ç¬¬ä¸€æ¬¡çœŸæ­£æ‹¥æœ‰äº†â€œå®æ—¶å¯¹è¯â€çš„èƒ½åŠ›ã€‚

---

## ğŸ§  æ ¸å¿ƒæ¦‚å¿µä¸æœ¯è¯­è§£é‡Š

| åç§°                 | è¯´æ˜                                       |
| ------------------ | ---------------------------------------- |
| **HTTP**           | ä¸€é—®ä¸€ç­”å‹åè®®ã€‚å®¢æˆ·ç«¯å‘è¯·æ±‚ï¼ŒæœåŠ¡å™¨å›å“åº”ï¼Œç„¶åæ–­å¼€ã€‚              |
| **é•¿è¿æ¥**            | ä¸€æ¡ä¿æŒä¸å…³é—­çš„ TCP è¿æ¥ï¼Œå¯åå¤æ”¶å‘æ•°æ®ã€‚                 |
| **WebSocket**      | ä¸€ç§åŸºäº TCP çš„åŒå‘é€šä¿¡åè®®ï¼Œèƒ½è®©æœåŠ¡å™¨ä¸»åŠ¨æ¨é€æ¶ˆæ¯ã€‚            |
| **æ¡æ‰‹ (Handshake)** | å®¢æˆ·ç«¯é€šè¿‡ HTTP è¯·æ±‚å‘Šè¯‰æœåŠ¡å™¨ï¼šâ€œæˆ‘æƒ³å‡çº§ä¸º WebSocket åè®®â€ã€‚ |
| **å¸§ (Frame)**      | WebSocket ä¼ è¾“çš„æœ€å°æ•°æ®å•å…ƒï¼Œæ¯” HTTP header æ›´è½»é‡ã€‚   |
| **å¿ƒè·³ (Ping/Pong)** | å®šæœŸå‘é€çš„å°æ•°æ®åŒ…ï¼Œé˜²æ­¢è¿æ¥è¶…æ—¶æ–­å¼€ã€‚                      |

---

## ğŸªœ å®è·µæŒ‡å—ï¼šWebSocket å»ºç«‹çš„å…¨è¿‡ç¨‹

1ï¸âƒ£ **æµè§ˆå™¨å‘èµ·è¯·æ±‚ï¼ˆHTTP é˜¶æ®µï¼‰**

```http
GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
```

è¡¨ç¤ºæƒ³æŠŠè¿™æ¬¡ HTTP é€šä¿¡â€œå‡çº§â€æˆ WebSocketã€‚

2ï¸âƒ£ **æœåŠ¡å™¨åŒæ„å¹¶è¿”å› 101 çŠ¶æ€ç **

```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=
```

3ï¸âƒ£ **è¿æ¥å‡çº§æˆåŠŸï¼**
æ­¤åï¼Œè¿™æ¡ TCP é€šé“ä¸å†èµ° HTTPï¼Œè€Œæ˜¯è¿›å…¥ WebSocket æ¨¡å¼ã€‚
åŒæ–¹éƒ½èƒ½éšæ—¶å‘é€å¸§ï¼ˆFrameï¼‰æ¶ˆæ¯ï¼Œä¸å†éœ€è¦é‡å»ºè¿æ¥ã€‚

---

## ğŸ’» å¯è¿è¡Œç¤ºä¾‹ï¼šFastAPI + åŸç”Ÿ WebSocket

```python
from fastapi import FastAPI, WebSocket

app = FastAPI()

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    await websocket.send_text("âœ… WebSocket å·²è¿æ¥")
    while True:
        msg = await websocket.receive_text()
        await websocket.send_text(f"ä½ å‘é€äº†ï¼š{msg}")
```

å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ï¼š

```js
const ws = new WebSocket("ws://localhost:8000/ws");
ws.onopen = () => ws.send("Hello Server");
ws.onmessage = e => console.log("æ”¶åˆ°ï¼š", e.data);
```

---

## ğŸ” è§£é‡Šä¸åŸç†ï¼šä¸ºä»€ä¹ˆ WebSocket èƒ½â€œä¿æŒè¿æ¥â€ï¼Ÿ

1ï¸âƒ£ **åº•å±‚æ˜¯ TCP é•¿è¿æ¥**
åªè¦åŒæ–¹ä¸ä¸»åŠ¨æ–­å¼€ï¼ŒTCP å°±èƒ½ä¸€ç›´ç»´æŒé€šé“ã€‚

2ï¸âƒ£ **å¿ƒè·³æœºåˆ¶é˜²æ­¢ä¸­é€”æ–­çº¿**
å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¼šå®šæœŸäº’å‘ ping/pong åŒ…ï¼Œå‘Šè¯‰å¯¹æ–¹â€œæˆ‘è¿˜æ´»ç€â€ã€‚

3ï¸âƒ£ **åè®®è½»é‡ã€å¯æŒç»­é€šä¿¡**
WebSocket æ•°æ®åŒ…æ ¼å¼æå°ï¼Œä¸”æ˜¯å…¨åŒå·¥ä¼ è¾“ï¼Œ
å¯åŒæ—¶è¿›è¡Œè¯»å–ä¸å†™å…¥ï¼Œä¸ä¼šé˜»å¡ã€‚

4ï¸âƒ£ **æœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€**
è¿™æ˜¯æœ€é©å‘½æ€§çš„å˜åŒ–ï¼šHTTP ä¸è¡Œï¼ŒWebSocket å¯ä»¥ã€‚

---

## ğŸ§© æ›¿ä»£æ–¹æ¡ˆä¸å–èˆ

| æ–¹æ¡ˆ                       | ä¼˜ç‚¹                       | ç¼ºç‚¹         | é€‚ç”¨åœºæ™¯         |
| ------------------------ | ------------------------ | ---------- | ------------ |
| HTTP è½®è¯¢                  | ç®€å•ã€é€šç”¨                    | å»¶è¿Ÿé«˜ã€æµªè´¹èµ„æº   | å°æµé‡ã€ä½å®æ—¶æ€§     |
| Long Polling             | å®ç°ç®€å•                     | ä»éœ€é¢‘ç¹è¯·æ±‚     | ä¸´æ—¶å…¼å®¹         |
| SSE (Server-Sent Events) | æœåŠ¡å™¨å•å‘æ¨é€                  | ä»…æ”¯æŒæ–‡æœ¬ã€æ— åŒå‘  | é€šçŸ¥ã€æ—¥å¿—æµ       |
| WebSocket                | åŒå‘å®æ—¶é€šä¿¡                   | éœ€ç»´æŠ¤çŠ¶æ€ã€å¤æ‚åº¦é«˜ | èŠå¤©ã€AIæµå¼è¾“å‡ºã€æ¸¸æˆ |
| Socket.IO                | WebSocket å°è£… + è‡ªåŠ¨é‡è¿ + æˆ¿é—´ | è¾ƒé‡         | å¤§è§„æ¨¡å®æ—¶ç³»ç»Ÿ      |

---

## âš ï¸ å¸¸è§é—®é¢˜ä¸æ³¨æ„äº‹é¡¹

| é—®é¢˜       | è¯´æ˜                          |
| -------- | --------------------------- |
| **è¿æ¥æ–­å¼€** | ç½‘ç»œæ³¢åŠ¨ã€ä»£ç†è¶…æ—¶ã€æœåŠ¡å™¨é‡å¯éƒ½ä¼šæ–­ï¼Œéœ€è¦é‡è¿é€»è¾‘ã€‚  |
| **å¿ƒè·³ç¼ºå¤±** | è‹¥é•¿æ—¶é—´æ—  ping/pongï¼Œè¿æ¥å¯èƒ½è¢«æ¸…ç†ã€‚    |
| **æ¶ˆæ¯ä¸¢å¤±** | é‡è¿åè¦åšæ¶ˆæ¯ ID å»é‡ã€è¡¥å‘æœºåˆ¶ã€‚         |
| **å®‰å…¨æ€§**  | ä½¿ç”¨ `wss://`ï¼ˆTLS åŠ å¯†ï¼‰é˜²æ­¢ä¸­é—´äººæ”»å‡»ã€‚ |
| **è´Ÿè½½å‡è¡¡** | å¤šå®ä¾‹éƒ¨ç½²éœ€ç”¨ Redisã€Kafka ç­‰å¹¿æ’­æ¶ˆæ¯ã€‚  |

---

## ğŸ’¡ æœ€ä½³å®è·µä¸å»ºè®®

1ï¸âƒ£ ä½¿ç”¨ **wss://**ï¼ˆåŠ å¯†è¿æ¥ï¼‰
2ï¸âƒ£ è®¾ç½® **ping/pong å¿ƒè·³**ï¼Œ3~5 åˆ†é’Ÿå‘é€ä¸€æ¬¡
3ï¸âƒ£ å»ºç«‹è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆSocket.IO å·²å†…ç½®ï¼‰
4ï¸âƒ£ åˆ†ç¦»â€œæ¡æ‰‹é‰´æƒâ€ä¸â€œæ¶ˆæ¯é€šé“â€
5ï¸âƒ£ éœ€è¦å¤šå®ä¾‹æ‰©å®¹æ—¶ï¼Œé…åˆ **Redis Pub/Sub** å®ç°è·¨èŠ‚ç‚¹å¹¿æ’­
6ï¸âƒ£ ä¸è¦ç”¨ WebSocket ä¼ å¤§æ–‡ä»¶ï¼ˆæ”¹ç”¨ HTTP ä¸Šä¼ ï¼‰

---

## ğŸ“˜ å°ç»“ / ç»“è®º

WebSocket ä¸åªæ˜¯â€œèŠ‚çœè¿æ¥å¼€é”€â€ï¼Œ
å®ƒè®© Web åº”ç”¨ç¬¬ä¸€æ¬¡å…·å¤‡äº†ï¼š

* åŒå‘é€šä¿¡ï¼›
* å®æ—¶æ¨é€ï¼›
* æµå¼ä¼ è¾“ï¼›
* çŠ¶æ€åŒæ­¥ã€‚

ä» HTTP çš„â€œä¸€é—®ä¸€ç­”â€ï¼Œ
åˆ° WebSocket çš„â€œéšæ—¶å¯¹è¯â€ï¼Œ
æˆ‘ä»¬æ­£åœ¨è¿ˆå‘çœŸæ­£çš„â€œå®æ—¶äº’è”ç½‘â€ã€‚

> ğŸ’¡ ä¸€å¥è¯æ€»ç»“ï¼š
> **HTTP æ˜¯é—®ç­”ï¼ŒWebSocket æ˜¯é€šè¯ã€‚**

---

## ğŸ“š å‚è€ƒä¸å»¶ä¼¸é˜…è¯»

* [MDN: WebSocket API](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API)
* [RFC 6455 - The WebSocket Protocol](https://datatracker.ietf.org/doc/html/rfc6455)
* [FastAPI WebSocket å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/advanced/websockets/)
* [Socket.IO å®˜æ–¹æ–‡æ¡£](https://socket.io/docs/v4/)
* [Real-Time Applications with Redis Pub/Sub](https://redis.io/docs/latest/develop/pubsub/)

---

## ğŸ·ï¸ å…ƒä¿¡æ¯

* â±ï¸ é˜…è¯»æ—¶é•¿ï¼šçº¦ 15 åˆ†é’Ÿ
* ğŸ“š æ ‡ç­¾ï¼š`WebSocket`ã€`HTTP`ã€`å®æ—¶é€šä¿¡`ã€`FastAPI`ã€`Socket.IO`
* ğŸ” SEO å…³é”®è¯ï¼šWebSocket æ•™ç¨‹ã€HTTP vs WebSocketã€é•¿è¿æ¥åŸç†ã€å®æ—¶èŠå¤©
* ğŸ“ å…ƒæè¿°ï¼šå…¨é¢è®²è§£ WebSocket çš„å·¥ä½œæœºåˆ¶ã€æ¡æ‰‹è¿‡ç¨‹ã€å¿ƒè·³ä¿æ´»ä¸å®é™…åº”ç”¨ï¼Œé€‚åˆå¸Œæœ›æŒæ¡å®æ—¶é€šä¿¡åŸç†çš„å¼€å‘è€…ã€‚

---

## ğŸš€ è¡ŒåŠ¨å·å¬ï¼ˆCTAï¼‰

æƒ³äº²æ‰‹è¯•è¯•ï¼Ÿ
ğŸ‘‰ ç”¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹æ­ä¸€ä¸ªæœ€å° WebSocket èŠå¤©æœåŠ¡ï¼
æœ‰é—®é¢˜æˆ–æƒ³æ·±å…¥åˆ° **Socket.IO + Redis åˆ†å¸ƒå¼æ¶æ„**ï¼Ÿ
æ¬¢è¿ç•™è¨€è¯„è®ºæˆ–è®¢é˜…åç»­æ–‡ç« ã€Šä»å•æœºåˆ°é›†ç¾¤ï¼šæ„å»ºå¯æ‰©å±•çš„å®æ—¶é€šä¿¡ç³»ç»Ÿã€‹ã€‚

